<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StayHub</title>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // --- Add Dark Mode to Tailwind ---
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    
    <style>
        .leaflet-container { height: 100%; width: 100%; z-index: 0; }
        .leaflet-pane { z-index: 0 !important; } 
        .leaflet-tile-pane { z-index: 0 !important; }
        /* Fix for map in dark mode */
        .leaflet-tile-pane {
             filter: brightness(0.9) invert(0) contrast(1) saturate(1);
        }
        .dark .leaflet-tile-pane {
             filter: brightness(0.6) invert(1) contrast(3) saturate(0.3);
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900">
    <div id="root"></div>

    <script type="text/babel">
        console.log("StayHub App Starting...");

        const { useState, useEffect, useRef, useCallback } = React;
        
        // --- API Configuration ---
        const API_BASE_URL = 'http://localhost:5000/api';
        // GEOAPIFY_API_KEY is now loaded from the server
        
        // --- Constants ---
        const PROPERTY_TYPES = [ '1 Room', '2 Rooms', '1 Room with Kitchen', '2 Rooms with Kitchen', '1 BHK', '2 BHK', 'Other' ];
        const FACILITY_OPTIONS = ['WiFi', 'Parking', 'AC', 'Gym', 'Laundry', 'Balcony'];
        
        // --- SVG Icons ---
        const icons = {
            search: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clipRule="evenodd" /></svg>,
            star: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>,
            close: <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" /></svg>,
            plus: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>,
            edit: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>,
            user: <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>,
            map: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clipRule="evenodd" /></svg>,
            moon: <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>,
            sun: <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M12 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
        };

        // --- 1. BASE COMPONENTS ---

        const InputField = ({ label, name, type = 'text', required = true, placeholder, value, onChange, isTextArea = false, readOnly = false }) => {
            const commonProps = {
                type,
                name,
                value: value || '',
                onChange,
                placeholder,
                readOnly,
                className: `mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm shadow-sm placeholder-gray-400 dark:placeholder-gray-500 focus:ring-indigo-500 focus:border-indigo-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 ${readOnly ? 'bg-gray-100 dark:bg-gray-800 cursor-not-allowed' : ''}`,
                required
            };
            return (
                <div className="text-gray-700 dark:text-gray-300">
                    <label className="text-sm font-medium">
                        {label}
                        {required && <span className="text-red-500">*</span>}
                    </label>
                    {isTextArea ? <textarea rows="3" {...commonProps}></textarea> : <input {...commonProps} />}
                </div>
            );
        };
        
        const MapLocationSelector = ({ location, onLocationSelect, geoApiKey }) => {
            const mapContainerRef = useRef(null);
            const mapRef = useRef(null);
            const markerRef = useRef(null);

            useEffect(() => {
                if (!mapContainerRef.current || !window.L || !geoApiKey) return;
                
                const defaultCenter = [30.3037, 78.0329];
                const lat = (location && typeof location.lat === 'number') ? location.lat : defaultCenter[0];
                const lng = (location && typeof location.lng === 'number') ? location.lng : defaultCenter[1];
                const initialPos = [lat, lng];

                if (!mapRef.current) {
                    mapRef.current = L.map(mapContainerRef.current).setView(initialPos, 12);
                    L.tileLayer(`https://maps.geoapify.com/v1/tile/osm-bright/{z}/{x}/{y}.png?apiKey=${geoApiKey}`, {
                        attribution: 'Powered by <a href="https://www.geoapify.com/" target="_blank">Geoapify</a>'
                    }).addTo(mapRef.current);

                    mapRef.current.on('click', async (e) => {
                        const { lat, lng } = e.latlng;
                        if (markerRef.current) { markerRef.current.setLatLng([lat, lng]); } else { markerRef.current = L.marker([lat, lng]).addTo(mapRef.current); }
                        try {
                            const response = await fetch(`https://api.geoapify.com/v1/geocode/reverse?lat=${lat}&lon=${lng}&apiKey=${geoApiKey}`);
                            const data = await response.json();
                            const newLocationData = { lat, lng, address: `Coordinates: (${lat.toFixed(4)}, ${lng.toFixed(4)})` };
                            if (data.features && data.features.length > 0) { newLocationData.address = data.features[0].properties.formatted; }
                            onLocationSelect(newLocationData);
                        } catch (error) { console.error("Reverse geocoding failed", error); }
                    });
                }
                if (location && typeof location.lat === 'number' && !markerRef.current) { markerRef.current = L.marker(initialPos).addTo(mapRef.current); }
            }, [geoApiKey, location.lat, location.lng]); // Re-run if key loads

            return (
                <div className="space-y-2">
                    <label className="text-sm font-medium text-gray-700 dark:text-gray-300 block">Select Location on Map<span className="text-red-500">*</span></label>
                    <div ref={mapContainerRef} style={{ height: '250px', width: '100%' }} className="rounded-md border border-gray-300 dark:border-gray-600"></div>
                </div>
            );
        };

        const FilterSidebar = ({ filters, onFilterChange, onApplyFilters, onClearFilters }) => {
            const handleTypeChange = (type) => onFilterChange('propertyType', type);
            const handleFacilityChange = (facility) => {
                const updated = filters.facilities.includes(facility) ? filters.facilities.filter(f => f !== facility) : [...filters.facilities, facility];
                onFilterChange('facilities', updated);
            };
            return (
                <aside className="w-full md:w-1/4 lg:w-1/5 p-4 bg-white dark:bg-gray-800 shadow-sm rounded-lg h-fit sticky top-20">
                    <h2 className="text-xl font-bold text-gray-800 dark:text-gray-100 mb-6 border-b border-gray-200 dark:border-gray-700 pb-2">Filter Properties</h2>
                    <div className="space-y-6">
                        <div>
                            <h3 className="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-3">Property Type</h3>
                            <div className="flex flex-col space-y-2 text-sm">
                                {PROPERTY_TYPES.map(type => (
                                    <label key={type} className="flex items-center cursor-pointer p-2 rounded-md transition-colors hover:bg-indigo-50 dark:hover:bg-gray-700">
                                        <input
                                            type="radio"
                                            name="propertyType"
                                            value={type}
                                            checked={filters.propertyType === type}
                                            onChange={() => handleTypeChange(type)}
                                            className="h-4 w-4 text-indigo-600 border-gray-300 dark:border-gray-600 focus:ring-indigo-500"
                                        />
                                        <span className="ml-2 text-gray-700 dark:text-gray-300">{type}</span>
                                    </label>
                                ))}
                                <label className="flex items-center cursor-pointer p-2 rounded-md transition-colors hover:bg-indigo-50 dark:hover:bg-gray-700">
                                    <input
                                        type="radio"
                                        name="propertyType"
                                        value=""
                                        checked={filters.propertyType === ''}
                                        onChange={() => handleTypeChange('')}
                                        className="h-4 w-4 text-indigo-600 border-gray-300 dark:border-gray-600 focus:ring-indigo-500"
                                    />
                                    <span className="ml-2 text-gray-700 dark:text-gray-300">All Types</span>
                                </label>
                            </div>
                        </div>
                        <div>
                            <h3 className="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-3">Key Facility</h3>
                            <div className="grid grid-cols-2 gap-2 text-sm">
                                {FACILITY_OPTIONS.map(facility => (
                                    <label key={facility} className="flex items-center cursor-pointer p-1 rounded-md transition-colors hover:bg-indigo-50 dark:hover:bg-gray-700">
                                        <input
                                            type="checkbox"
                                            checked={filters.facilities.includes(facility)}
                                            onChange={() => handleFacilityChange(facility)}
                                            className="h-4 w-4 text-indigo-600 border-gray-300 dark:border-gray-600 rounded focus:ring-indigo-500"
                                        />
                                        <span className="ml-2 text-gray-700 dark:text-gray-300">{facility}</span>
                                    </label>
                                ))}
                            </div>
                        </div>
                    </div>
                    <div className="mt-8 flex flex-col space-y-2">
                        <button onClick={onApplyFilters} className="w-full px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">Apply Filters</button>
                        <button onClick={onClearFilters} className="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700">Clear Filters</button>
                    </div>
                </aside>
            );
        };

        const Navigation = ({ currentUser, onLoginClick, onLogout, onDashboardClick, onEditProfileClick, onHomeClick, theme, toggleTheme }) => (
            <header className="bg-white/80 dark:bg-gray-800/80 backdrop-blur-md shadow-sm sticky top-0 z-40">
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div className="flex items-center justify-between h-16">
                        <div className="flex-shrink-0">
                            <h1 className="text-2xl font-bold text-gray-800 dark:text-gray-100 cursor-pointer" onClick={onHomeClick}>StayHub</h1>
                        </div>
                        <nav className="flex items-center space-x-4">
                            {currentUser && currentUser.role === 'owner' && currentUser.verified && (
                                <button onClick={onDashboardClick} className="px-3 py-2 text-sm font-medium text-indigo-600 bg-indigo-100 dark:bg-indigo-900 dark:text-indigo-200 rounded-md hover:bg-indigo-200 dark:hover:bg-indigo-800">Owner Dashboard</button>
                            )}
                            {currentUser ? (
                                <>
                                    <span className="hidden sm:inline text-gray-700 dark:text-gray-300 font-medium">Welcome, {currentUser.name}!</span>
                                    <button onClick={onEditProfileClick} className="p-2 rounded-full text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">{icons.user}</button>
                                    <button onClick={onLogout} className="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700">Logout</button>
                                </>
                            ) : (
                                <button onClick={onLoginClick} className="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700">Login</button>
                            )}
                            <button onClick={toggleTheme} className="p-2 rounded-full text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                                {theme === 'dark' ? icons.sun : icons.moon}
                            </button>
                        </nav>
                    </div>
                </div>
            </header>
        );

        const RoomCard = ({ room, isDashboard = false, onEdit, onClick }) => (
            <div className="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden transform hover:-translate-y-1 transition-transform duration-300 cursor-pointer" onClick={onClick}>
                <div className="relative">
                    {isDashboard && room.status === 'inactive' && <div className="absolute top-2 left-2 bg-yellow-500 text-white text-xs font-bold px-2 py-1 rounded-full z-10">DRAFT</div>}
                    <img className="h-56 w-full object-cover" src={room.images && room.images.length > 0 ? room.images[0] : 'https://placehold.co/600x400?text=No+Image'} alt={room.title} />
                </div>
                <div className="p-4">
                    <h3 className="text-lg font-semibold text-gray-800 dark:text-gray-100 truncate">{room.title}</h3>
                    <p className="text-sm text-gray-600 dark:text-gray-400 mt-1 truncate">{room.location}</p>
                    <div className="flex items-center justify-between mt-2">
                        <div className="flex flex-col">
                            <div className="flex items-center text-sm text-gray-700 dark:text-gray-300">
                                {icons.star}
                                <span className="ml-1">{room.rating || 'New'}</span>
                            </div>
                            {!isDashboard && room.distance !== undefined && (
                                <span className="text-xs text-indigo-600 dark:text-indigo-400 mt-1 font-medium flex items-center">
                                    {icons.map} {room.distance.toFixed(1)} km away
                                </span>
                            )}
                        </div>
                        {isDashboard && (
                            <button
                                onClick={(e) => { e.stopPropagation(); onEdit(room); }}
                                className="text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 dark:hover:text-indigo-300 flex items-center text-sm font-medium"
                            >
                                {icons.edit}
                                <span className="ml-1">Edit</span>
                            </button>
                        )}
                    </div>
                    <p className="text-lg font-bold text-gray-900 dark:text-white mt-2">
                        ₹{room.price.toLocaleString()} <span className="text-sm font-normal text-gray-600 dark:text-gray-400">/ month</span>
                    </p>
                </div>
            </div>
        );

        // --- 2. MODALS (Defined before use) ---

        const RoomDetailModal = ({ isOpen, onClose, room }) => {
            if (!isOpen || !room) return null;
            const ownerContact = room.owner || { name: 'N/A', email: 'N/A', phone: 'N/A' };
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 max-w-3xl w-full relative max-h-[90vh] overflow-y-auto">
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600 dark:text-gray-300 dark:hover:text-white">{icons.close}</button>
                        <h2 className="text-3xl font-bold text-gray-800 dark:text-gray-100 mb-2">{room.title}</h2>
                        <p className="text-lg text-gray-600 dark:text-gray-400 mb-4">{room.location}</p>
                        <div className="grid grid-cols-2 gap-2 mb-6">
                            {room.images.slice(0, 4).map((img, index) =>
                                <img key={index} src={img} alt={`${room.title} ${index + 1}`} className="h-40 w-full object-cover rounded-lg" />
                            )}
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                            <div>
                                <p className="text-3xl font-extrabold text-indigo-600 dark:text-indigo-400 mb-4">
                                    ₹{room.price.toLocaleString()} <span className="text-lg font-normal text-gray-600 dark:text-gray-400">/ month</span>
                                </p>
                                <p className="text-md font-medium text-gray-700 dark:text-gray-300 mb-1">Type: {room.type}</p>
                                <p className="text-md font-medium text-gray-700 dark:text-gray-300 mb-1">Capacity: {room.capacity} Guests</p>
                                <div className="flex items-center text-md text-gray-700 dark:text-gray-300 mt-2">
                                    {icons.star}
                                    <span className="ml-1">{room.rating || 'New'}</span>
                                </div>
                                {room.distance && (
                                    <p className="text-md text-gray-700 dark:text-gray-300 mt-1 flex items-center">
                                        {icons.map}
                                        <span className="ml-1">{room.distance.toFixed(1)} km away</span>
                                    </p>
                                )}
                            </div>
                            <div className="md:col-span-2">
                                <h3 className="text-xl font-semibold text-gray-800 dark:text-gray-100 mb-2">Description</h3>
                                <p className="text-gray-600 dark:text-gray-400 mb-4">{room.description}</p>
                                <h3 className="text-xl font-semibold text-gray-800 dark:text-gray-100 mb-2">Facilities</h3>
                                <ul className="list-disc list-inside text-gray-600 dark:text-gray-400 columns-2">
                                    {room.facilities.map((f, i) => <li key={i}>{f}</li>)}
                                </ul>
                            </div>
                        </div>
                        <div className="mt-8 p-4 border-t border-gray-200 dark:border-gray-700">
                            <h3 className="text-xl font-semibold text-gray-800 dark:text-gray-100 mb-2">Contact Owner</h3>
                            <p className="text-gray-700 dark:text-gray-300">Name: {ownerContact.name}</p>
                            <p className="text-gray-700 dark:text-gray-300">
                                Email: <a href={`mailto:${ownerContact.email}`} className="text-indigo-600 dark:text-indigo-400">{ownerContact.email}</a>
                            </p>
                            <p className="text-gray-700 dark:text-gray-300">Phone: {ownerContact.phone}</p>
                        </div>
                    </div>
                </div>
            );
        };

        const AuthModal = ({ isOpen, onClose, onLoginSuccess }) => {
            if (!isOpen) return null;
            const [isLoginView, setIsLoginView] = useState(true);
            const [formData, setFormData] = useState({ name: '', email: '', password: '', phone: '' });
            const [role, setRole] = useState('guest');
            const [message, setMessage] = useState('');

            const handleSubmit = async (e) => {
                e.preventDefault();
                setMessage('');
                const endpoint = isLoginView ? `${API_BASE_URL}/auth/login` : `${API_BASE_URL}/auth/register`;
                const payload = isLoginView ? { email: formData.email, password: formData.password } : { ...formData, role };
                try {
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const data = await response.json();
                    if (!response.ok) {
                        setMessage(data.msg || 'An error occurred.');
                        return;
                    }
                    if (isLoginView) {
                        onLoginSuccess(data.user);
                        onClose();
                    } else {
                        setMessage(data.user.role === 'owner' && !data.user.verified ? `Owner registration successful! Your account is pending verification.` : 'Registration successful! Please log in.');
                        setFormData({ name: '', email: '', password: '', phone: '' });
                        setTimeout(() => { setIsLoginView(true); setMessage(''); }, 2000);
                    }
                } catch (error) {
                    setMessage('Network error. Is the backend server running?');
                    console.error('Auth Error:', error);
                }
            };
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 m-4 max-w-md w-full relative">
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600 dark:text-gray-300 dark:hover:text-white">{icons.close}</button>
                        <h2 className="text-2xl font-bold text-center text-gray-800 dark:text-gray-100 mb-4">Welcome to StayHub</h2>
                        <div className="flex bg-gray-100 dark:bg-gray-700 rounded-lg p-1 mb-6">
                            <button
                                onClick={() => setIsLoginView(true)}
                                className={`flex-1 py-2 rounded-md text-sm font-medium ${isLoginView ? 'bg-white dark:bg-gray-800 shadow text-indigo-600 dark:text-indigo-300' : 'text-gray-600 dark:text-gray-300'}`}
                            >
                                Login
                            </button>
                            <button
                                onClick={() => setIsLoginView(false)}
                                className={`flex-1 py-2 rounded-md text-sm font-medium ${!isLoginView ? 'bg-white dark:bg-gray-800 shadow text-indigo-600 dark:text-indigo-300' : 'text-gray-600 dark:text-gray-300'}`}
                            >
                                Register
                            </button>
                        </div>
                        {message && (
                            <div className={`p-3 mb-4 rounded-md text-sm ${message.includes('success') ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                {message}
                            </div>
                        )}
                        <form onSubmit={handleSubmit} className="space-y-4">
                            {!isLoginView && (
                                <>
                                    <p className="text-sm font-medium text-gray-700 dark:text-gray-300">Register as:</p>
                                    <div className="flex space-x-4">
                                        <label className="flex items-center">
                                            <input type="radio" name="role" value="guest" checked={role === 'guest'} onChange={() => setRole('guest')} className="h-4 w-4 text-indigo-600" />
                                            <span className="ml-2 text-sm text-gray-700 dark:text-gray-300">Guest</span>
                                        </label>
                                        <label className="flex items-center">
                                            <input type="radio" name="role" value="owner" checked={role === 'owner'} onChange={() => setRole('owner')} className="h-4 w-4 text-indigo-600" />
                                            <span className="ml-2 text-sm text-gray-700 dark:text-gray-300">Owner</span>
                                        </label>
                                    </div>
                                    <InputField
                                        label="Full Name"
                                        name="name"
                                        placeholder="Enter full name"
                                        value={formData.name}
                                        onChange={e => setFormData({...formData, name: e.target.value})}
                                    />
                                </>
                            )}
                            <InputField
                                label="Email"
                                name="email"
                                type="email"
                                placeholder="Enter your email"
                                value={formData.email}
                                onChange={e => setFormData({...formData, email: e.target.value})}
                            />
                            <InputField
                                label="Password"
                                name="password"
                                type="password"
                                placeholder={isLoginView ? "Enter password" : "Create password"}
                                value={formData.password}
                                onChange={e => setFormData({...formData, password: e.target.value})}
                            />
                            {!isLoginView && (
                                <InputField
                                    label="Phone Number"
                                    name="phone"
                                    type="tel"
                                    required={false}
                                    placeholder="Enter phone number"
                                    value={formData.phone}
                                    onChange={e => setFormData({...formData, phone: e.target.value})}
                                />
                            )}
                            <button
                                type="submit"
                                className="w-full py-2 px-4 border rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700"
                            >
                                {isLoginView ? 'Login' : 'Register'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        const EditProfileModal = ({ isOpen, onClose, currentUser, onProfileUpdate }) => {
            if (!isOpen || !currentUser) return null;
            const [formData, setFormData] = useState({ name: currentUser.name || '', phone: currentUser.phone || '', newPassword: '' });
            const [loading, setLoading] = useState(false);
            const [message, setMessage] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                setLoading(true);
                setMessage('');
                // Mock API call simulation
                setTimeout(() => {
                    const updatedUser = { ...currentUser, name: formData.name, phone: formData.phone };
                    onProfileUpdate(updatedUser);
                    setMessage('Profile updated successfully!');
                    setLoading(false);
                    setTimeout(onClose, 1500);
                }, 1000);
            };
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 max-w-md w-full relative">
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600 dark:text-gray-300 dark:hover:text-white">{icons.close}</button>
                        <h2 className="text-2xl font-bold text-center text-gray-800 dark:text-gray-100 mb-6">Edit Your Profile</h2>
                        {message && (
                            <div className={`p-3 mb-4 rounded-md text-sm ${message.includes('success') ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                {message}
                            </div>
                        )}
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <InputField
                                label="Full Name"
                                name="name"
                                value={formData.name}
                                onChange={e => setFormData({...formData, name: e.target.value})}
                            />
                            <InputField
                                label="Email Address"
                                name="email"
                                type="email"
                                value={currentUser.email}
                                readOnly={true}
                            />
                            <InputField
                                label="Phone Number"
                                name="phone"
                                type="tel"
                                required={false}
                                value={formData.phone}
                                onChange={e => setFormData({...formData, phone: e.target.value})}
                            />
                            <InputField
                                label="New Password (Optional)"
                                name="newPassword"
                                type="password"
                                required={false}
                                placeholder="Leave blank"
                                value={formData.newPassword}
                                onChange={e => setFormData({...formData, newPassword: e.target.value})}
                            />
                            <button
                                type="submit"
                                disabled={loading}
                                className={`w-full py-2 px-4 border rounded-md shadow-sm text-sm font-medium text-white ${loading ? 'bg-indigo-400' : 'bg-indigo-600 hover:bg-indigo-700'}`}
                            >
                                {loading ? 'Saving...' : 'Save Changes'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        const AddEditRoomModal = ({ isOpen, onClose, ownerId, initialRoomData, onRoomModified, geoApiKey }) => {
            if (!isOpen) return null;
            const isEditing = !!initialRoomData;
            
            const getInitialState = () => {
                if (isEditing) {
                    const lat = initialRoomData.geo?.coordinates ? initialRoomData.geo.coordinates[1] : (initialRoomData.latitude || 0);
                    const lng = initialRoomData.geo?.coordinates ? initialRoomData.geo.coordinates[0] : (initialRoomData.longitude || 0);
                    return {
                        id: initialRoomData._id,
                        title: initialRoomData.title,
                        description: initialRoomData.description,
                        price: String(initialRoomData.price),
                        type: initialRoomData.type,
                        location: { address: initialRoomData.location, lat, lng },
                        capacity: String(initialRoomData.capacity),
                        images: initialRoomData.images.join(', '),
                        facilities: Array.isArray(initialRoomData.facilities) ? initialRoomData.facilities : [],
                        status: initialRoomData.status
                    };
                }
                return {
                    title: '',
                    description: '',
                    price: '',
                    type: PROPERTY_TYPES[0],
                    location: { address: '', lat: null, lng: null },
                    capacity: '',
                    images: '',
                    facilities: [],
                    status: 'active'
                };
            };
            
            const [formData, setFormData] = useState(getInitialState);
            const [loading, setLoading] = useState(false);
            const [message, setMessage] = useState('');

            const handleInputChange = (e) => setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));
            const handleAddressChange = (e) => setFormData(prev => ({ ...prev, location: { ...prev.location, address: e.target.value, lat: null, lng: null } }));
            const handleLocationSelect = (newLocationData) => setFormData(prev => ({ ...prev, location: { ...prev.location, ...newLocationData } }));
            
            const handleFacilityChange = (facility) => {
                setFormData(prev => {
                    const updated = prev.facilities.includes(facility) ? prev.facilities.filter(f => f !== facility) : [...prev.facilities, facility];
                    return { ...prev, facilities: updated };
                });
            };

            const handleSubmit = async (e, submitStatus) => {
                e.preventDefault();
                setLoading(true);
                setMessage('');
                
                if (!formData.location.lat) { setMessage('Please select location on map.'); setLoading(false); return; }
                
                const finalRoomData = {
                    ...formData,
                    price: parseFloat(formData.price),
                    capacity: parseInt(formData.capacity),
                    status: submitStatus,
                    location: formData.location.address,
                    latitude: formData.location.lat,
                    longitude: formData.location.lng,
                    images: formData.images.split(',').map(img => img.trim()).filter(Boolean),
                    facilities: formData.facilities
                };
                
                if (finalRoomData.images.length === 0) { setMessage('Please provide at least one image URL.'); setLoading(false); return; }
                
                const endpoint = isEditing ? `${API_BASE_URL}/rooms/edit/${formData.id}` : `${API_BASE_URL}/rooms/add`;
                const method = isEditing ? 'PUT' : 'POST';
                
                try {
                    const response = await fetch(endpoint, {
                        method,
                        headers: {
                            'Content-Type': 'application/json',
                            'x-user-id': ownerId,
                            'x-user-role': 'owner'
                        },
                        body: JSON.stringify(finalRoomData)
                    });
                    const data = await response.json();
                    if (!response.ok) { throw new Error(data.msg || 'API Error'); }
                    
                    onRoomModified();
                    setMessage(`Property successfully ${isEditing ? 'updated' : 'added'}.`);
                    
                    setTimeout(() => { setLoading(false); onClose(); }, 1500);
                } catch (error) {
                    console.error("Submit Error:", error);
                    setMessage(error.message || `Network error.`);
                    setLoading(false);
                }
            };
            
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 max-w-xl w-full relative max-h-[90vh] overflow-y-auto">
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600 dark:text-gray-300 dark:hover:text-white">{icons.close}</button>
                        <h2 className="text-2xl font-bold text-center text-gray-800 dark:text-gray-100 mb-6">{isEditing ? 'Edit Property' : 'List New Property'}</h2>
                        {message && (
                            <div className={`p-3 mb-4 rounded-md text-sm ${message.includes('success') ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                {message}
                            </div>
                        )}
                        <form className="space-y-4">
                            <InputField label="Property Title" name="title" value={formData.title} onChange={handleInputChange} />
                            <InputField label="Description" name="description" isTextArea={true} value={formData.description} onChange={handleInputChange} />
                            
                            <div style={{height: "250px", width: "100%"}}>
                                <MapLocationSelector location={formData.location} onLocationSelect={handleLocationSelect} geoApiKey={geoApiKey} />
                            </div>
                            
                            <div>
                                <label className="text-sm font-medium text-gray-700 dark:text-gray-300">Selected Address<span className="text-red-500">*</span></label>
                                <input
                                    type="text"
                                    name="address"
                                    value={formData.location.address || ''}
                                    onChange={handleAddressChange}
                                    className="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200"
                                    required
                                />
                            </div>
                            
                            <div>
                                <label className="text-sm font-medium text-gray-700 dark:text-gray-300">Property Type<span className="text-red-500">*</span></label>
                                <select
                                    name="type"
                                    value={formData.type}
                                    onChange={handleInputChange}
                                    className="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200"
                                >
                                    {PROPERTY_TYPES.map(type => <option key={type} value={type}>{type}</option>)}
                                </select>
                            </div>
                            
                            <div className="grid grid-cols-2 gap-4">
                                <InputField label="Price (₹/month)" name="price" type="number" value={formData.price} onChange={handleInputChange} />
                                <InputField label="Capacity (Guests)" name="capacity" type="number" value={formData.capacity} onChange={handleInputChange} />
                            </div>
                            
                            <InputField label="Image URLs (Comma Separated)" name="images" value={formData.images} onChange={handleInputChange} />
                            
                            <div>
                                <label className="text-sm font-medium text-gray-700 dark:text-gray-300">Facilities</label>
                                <div className="mt-2 grid grid-cols-3 gap-3 text-sm">
                                    {FACILITY_OPTIONS.map(facility => (
                                        <label key={facility} className="flex items-center cursor-pointer p-2 border rounded-md border-gray-300 dark:border-gray-700 transition-colors hover:bg-indigo-50 dark:hover:bg-gray-700">
                                            <input
                                                type="checkbox"
                                                checked={formData.facilities.includes(facility)}
                                                onChange={() => handleFacilityChange(facility)}
                                                className="h-4 w-4 text-indigo-600 border-gray-300 dark:border-gray-600 rounded"
                                            />
                                            <span className="ml-2 text-gray-700 dark:text-gray-300">{facility}</span>
                                        </label>
                                    ))}
                                </div>
                            </div>
                            
                            <div className="flex space-x-4 pt-4">
                                <button
                                    type="button"
                                    onClick={(e) => handleSubmit(e, 'inactive')}
                                    disabled={loading}
                                    className={`flex-1 py-2 px-4 border rounded-md shadow-sm text-sm font-medium text-gray-700 bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500 ${loading && 'opacity-50'}`}
                                >
                                    Save as Draft
                                </button>
                                <button
                                    type="submit"
                                    onClick={(e) => handleSubmit(e, 'active')}
                                    disabled={loading}
                                    className={`flex-1 py-2 px-4 border rounded-md shadow-sm text-sm font-medium text-white ${loading ? 'bg-indigo-400' : 'bg-indigo-600 hover:bg-indigo-700'}`}
                                >
                                    {isEditing ? 'Update & List' : 'List Immediately'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };
        
        const MapSearchModal = ({ isOpen, onClose, onApplySearch, initialLocation, geoApiKey }) => {
            if (!isOpen) return null;
            const [selectedLocation, setSelectedLocation] = useState(initialLocation);
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 max-w-xl w-full relative max-h-[90vh] overflow-y-auto">
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600 dark:text-gray-300 dark:hover:text-white">{icons.close}</button>
                        <h2 className="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-6">Select Search Area</h2>
                        <div style={{height: "300px", width: "100%"}}>
                            <MapLocationSelector location={selectedLocation} onLocationSelect={setSelectedLocation} geoApiKey={geoApiKey} />
                        </div>
                        <div className="mt-4">
                            <label className="text-sm font-medium text-gray-700 dark:text-gray-300">Max Distance (km)</label>
                            <input
                                type="number"
                                value={selectedLocation.distance || 10}
                                onChange={(e) => setSelectedLocation(prev => ({ ...prev, distance: parseFloat(e.target.value) }))}
                                className="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200"
                            />
                        </div>
                        <div className="mt-6 flex justify-end space-x-3">
                            <button onClick={onClose} className="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-200 border dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700">Cancel</button>
                            <button
                                onClick={() => onApplySearch(selectedLocation)}
                                disabled={!selectedLocation.lat}
                                className="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md disabled:bg-indigo-300"
                            >
                                Apply Search
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- 3. PAGES ---

        const OwnerDashboard = ({ currentUser, onRoomModified, ownerRooms, geoApiKey }) => {
            const [showModal, setShowModal] = useState(false);
            const [editingRoom, setEditingRoom] = useState(null);
            
            const listedRooms = ownerRooms.filter(r => r.status === 'active');
            const draftRooms = ownerRooms.filter(r => r.status === 'inactive');

            const handleOpenAdd = () => { setEditingRoom(null); setShowModal(true); };
            const handleOpenEdit = (room) => { setEditingRoom(room); setShowModal(true); };

            if (!currentUser.verified) {
                return <p className="text-center p-8 text-yellow-600 bg-yellow-100 rounded-lg max-w-xl mx-auto mt-8">Your account is pending verification.</p>;
            }

            const RoomSection = ({ title, rooms }) => (
                <div className="mb-10">
                    <h3 className="text-xl font-semibold text-gray-800 dark:text-gray-100 mb-4">{title} ({rooms.length})</h3>
                    <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                        {rooms.length > 0 ? (
                            rooms.map(room => (
                                <RoomCard key={room._id} room={room} isDashboard={true} onEdit={handleOpenEdit} onClick={() => {}} />
                            ))
                        ) : (
                            <p className="col-span-full text-center p-4 border border-dashed border-gray-300 dark:border-gray-700 rounded-lg text-gray-500 dark:text-gray-400">No rooms in this section.</p>
                        )}
                    </div>
                </div>
            );

            return (
                <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <div className="flex justify-between items-center mb-8">
                        <h2 className="text-3xl font-extrabold text-gray-900 dark:text-gray-100">Property Management</h2>
                        <button onClick={handleOpenAdd} className="flex items-center px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700">
                            {icons.plus} <span className="ml-2">Add New Property</span>
                        </button>
                    </div>
                    <RoomSection title="Listed Rooms (Active)" rooms={listedRooms} />
                    <RoomSection title="Draft Rooms (Inactive)" rooms={draftRooms} />
                    <AddEditRoomModal
                        isOpen={showModal}
                        onClose={() => setShowModal(false)}
                        ownerId={currentUser.id}
                        initialRoomData={editingRoom}
                        onRoomModified={onRoomModified}
                        geoApiKey={geoApiKey}
                    />
                </main>
            );
        };

        const HomePage = ({ rooms, onRoomClick, filters, onFilterChange, onApplyFilters, onClearFilters, onApplySearch, geoApiKey }) => {
            const [searchLocationModal, setSearchLocationModal] = useState(false);
            const [tempLocation, setTempLocation] = useState({ address: '', lat: null, lng: null, distance: 10 });
            const [isSearching, setIsSearching] = useState(false);

            const handleManualSearch = async () => {
                if (tempLocation.lat && tempLocation.lng) {
                    onApplySearch(tempLocation);
                    return;
                }
                if (tempLocation.address && !tempLocation.lat) {
                    setIsSearching(true);
                    try {
                        const encodedText = encodeURIComponent(tempLocation.address);
                        const response = await fetch(`https://api.geoapify.com/v1/geocode/search?text=${encodedText}&apiKey=${geoApiKey}`);
                        const data = await response.json();
                        if (data.features && data.features.length > 0) {
                            const bestMatch = data.features[0];
                            const newLocation = {
                                ...tempLocation,
                                lat: bestMatch.properties.lat,
                                lng: bestMatch.properties.lon,
                                address: bestMatch.properties.formatted
                            };
                            setTempLocation(newLocation);
                            onApplySearch(newLocation);
                        } else {
                            alert("Address not found. Please try a different address or use the map.");
                        }
                    } catch (error) {
                        console.error("Geocoding error:", error);
                        alert("Error finding location.");
                    }
                    finally { setIsSearching(false); }
                } else {
                    alert("Please enter an address or select a location on the map.");
                }
            };

            return (
                <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <div className="flex flex-col md:flex-row gap-8">
                        <FilterSidebar
                            filters={filters}
                            onFilterChange={onFilterChange}
                            onApplyFilters={onApplyFilters}
                            onClearFilters={onClearFilters}
                        />
                        <div className="w-full md:w-3/4 lg:w-4/5">
                            <div className="mb-6 p-4 bg-white dark:bg-gray-800 shadow-sm rounded-lg">
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                                    <div className="md:col-span-2">
                                        <label className="text-sm font-medium text-gray-700 dark:text-gray-300">Location Address</label>
                                        <input
                                            type="text"
                                            value={tempLocation.address || ""}
                                            onChange={(e) => setTempLocation(prev => ({...prev, address: e.target.value, lat: null, lng: null}))}
                                            placeholder="Enter address (e.g. 'Mumbai') or select on map"
                                            className="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 focus:ring-indigo-500 focus:border-indigo-500"
                                        />
                                    </div>
                                    <div className="flex space-x-2">
                                        <button
                                            onClick={() => setSearchLocationModal(true)}
                                            className="flex-1 w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm font-medium text-gray-700 dark:text-gray-200 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600"
                                        >
                                            Select on Map
                                        </button>
                                        <button
                                            onClick={handleManualSearch}
                                            disabled={isSearching}
                                            className="flex-1 w-full px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 disabled:bg-indigo-400"
                                        >
                                            {isSearching ? 'Finding...' : 'Search'}
                                        </button>
                                    </div>
                                </div>
                                { !tempLocation.lat && <p className="mt-2 text-xs text-gray-500 dark:text-gray-400">Select a location or type an address to see distances.</p> }
                            </div>
                            <div className="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
                                { rooms.length > 0 ? (
                                    rooms.map(room => <RoomCard key={room._id} room={room} onClick={() => onRoomClick(room)} />)
                                ) : (
                                    <p className="text-center col-span-full text-gray-500 dark:text-gray-400 py-10">No active rooms found matching your criteria.</p>
                                )}
                            </div>
                        </div>
                    </div>
                    <MapSearchModal
                        isOpen={searchLocationModal}
                        onClose={() => setSearchLocationModal(false)}
                        onApplySearch={(loc) => { setTempLocation(loc); onApplySearch(loc); setSearchLocationModal(false); }}
                        initialLocation={tempLocation}
                        geoApiKey={geoApiKey}
                    />
                </main>
            );
        };

        // --- 4. MAIN APP COMPONENT ---

        const App = () => {
            const [currentUser, setCurrentUser] = useState(null);
            const [view, setView] = useState('home');
            const [theme, setTheme] = useState('light'); // 'light' or 'dark'
            const [geoApiKey, setGeoApiKey] = useState(null); // API key state
            const [isLoading, setIsLoading] = useState(true); // Loading state
            
            const [showAuthModal, setShowAuthModal] = useState(false);
            const [showProfileModal, setShowProfileModal] = useState(false);
            const [showDetailModal, setShowDetailModal] = useState(false);
            const [selectedRoom, setSelectedRoom] = useState(null);
            
            const [publicRooms, setPublicRooms] = useState([]);
            const [allRooms, setAllRooms] = useState([]);
            const [filters, setFilters] = useState({ propertyType: '', facilities: [] });
            const [searchLocation, setSearchLocation] = useState({ address: '', lat: null, lng: null, distance: 10 });
            
            // --- NEW: Load API Key and Theme ---
            useEffect(() => {
                // Fetch API Key
                fetch(`${API_BASE_URL}/config`)
                    .then(res => res.json())
                    .then(config => {
                        setGeoApiKey(config.geoApiKey);
                        setIsLoading(false); // We have the key, stop loading
                    })
                    .catch(err => {
                        console.error("Failed to fetch API config", err);
                        setIsLoading(false); // Stop loading even if it fails
                    });
                
                // Check for saved theme
                const savedTheme = localStorage.getItem('theme') || 'light';
                setTheme(savedTheme);
                if (savedTheme === 'dark') {
                    document.documentElement.classList.add('dark');
                }
            }, []);
            
            const toggleTheme = () => {
                const newTheme = theme === 'light' ? 'dark' : 'light';
                setTheme(newTheme);
                localStorage.setItem('theme', newTheme);
                if (newTheme === 'dark') {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            };
            
            const fetchRoomsAPI = async (queryParams = {}) => {
                Object.keys(queryParams).forEach(key => (queryParams[key] == null || queryParams[key] === '' || (Array.isArray(queryParams[key]) && queryParams[key].length === 0)) && delete queryParams[key]);
                const params = new URLSearchParams(queryParams);
                try {
                    const response = await fetch(`${API_BASE_URL}/rooms?${params.toString()}`);
                    if (!response.ok) throw new Error('Failed to fetch rooms');
                    const data = await response.json();
                    return data.map(room => ({ ...room, images: Array.isArray(room.images) && room.images.length > 0 ? room.images : ['https://placehold.co/600x400?text=No+Image'] }));
                } catch (error) {
                    console.error('API Error:', error);
                    return [];
                }
            };

            const fetchPublicData = async (currentFilters, currentSearch) => {
                const query = { status: 'active' };
                if (currentFilters.propertyType) { query.type = currentFilters.propertyType; }
                if (currentFilters.facilities && currentFilters.facilities.length > 0) { query.facilities = currentFilters.facilities.join(','); }
                if (currentSearch && currentSearch.lat) { query.lat = currentSearch.lat; query.lng = currentSearch.lng; query.maxDistance = currentSearch.distance; }
                const roomsData = await fetchRoomsAPI(query);
                setPublicRooms(roomsData);
            };

            const fetchAllOwnerData = async () => {
                const allData = await fetchRoomsAPI({});
                setAllRooms(allData);
            };

            useEffect(() => {
                if (!isLoading) { // Don't fetch rooms until we have the API key
                    fetchPublicData(filters, searchLocation);
                }
            }, [isLoading]); // Run once when isLoading becomes false
            
            useEffect(() => {
                if (view === 'owner_dashboard' && currentUser) {
                    fetchAllOwnerData();
                }
            }, [view, currentUser]);

            const handleLogin = (user) => { setCurrentUser(user); setView(user.role === 'owner' && user.verified ? 'owner_dashboard' : 'home'); };
            const handleRoomClick = (room) => { setSelectedRoom(room); setShowDetailModal(true); };
            const handleFilterChange = (key, value) => setFilters(prev => ({ ...prev, [key]: value }));
            const handleApplyFilters = () => { fetchPublicData(filters, searchLocation); };
            const handleClearFilters = () => {
                const cleared = { propertyType: '', facilities: [] };
                setFilters(cleared);
                fetchPublicData(cleared, searchLocation);
            };
            const handleApplySearch = (currentSearch) => { setSearchLocation(currentSearch); fetchPublicData(filters, currentSearch); };
            
            // --- Loading State ---
            if (isLoading) {
                return <div className="min-h-screen flex items-center justify-center bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200">Loading...</div>
            }

            let content;
            if (view === 'owner_dashboard' && currentUser?.role === 'owner') {
                const ownerRooms = allRooms.filter(room => String(room.owner?._id) === String(currentUser.id));
                content = (
                    <OwnerDashboard
                        currentUser={currentUser}
                        onRoomModified={fetchAllOwnerData}
                        ownerRooms={ownerRooms}
                        geoApiKey={geoApiKey}
                    />
                );
            } else {
                content = (
                    <HomePage
                        rooms={publicRooms}
                        onRoomClick={handleRoomClick}
                        filters={filters}
                        onFilterChange={handleFilterChange}
                        onApplyFilters={handleApplyFilters}
                        onClearFilters={handleClearFilters}
                        onApplySearch={handleApplySearch}
                        geoApiKey={geoApiKey}
                    />
                );
            }

            return (
                <div className="min-h-screen bg-gray-50 dark:bg-gray-900">
                    <Navigation
                        currentUser={currentUser}
                        onLoginClick={() => setShowAuthModal(true)}
                        onLogout={() => {setCurrentUser(null); setView('home');}}
                        onDashboardClick={() => setView('owner_dashboard')}
                        onEditProfileClick={() => setShowProfileModal(true)}
                        onHomeClick={() => setView('home')}
                        theme={theme}
                        toggleTheme={toggleTheme}
                    />
                    {content}
                    <AuthModal isOpen={showAuthModal} onClose={() => setShowAuthModal(false)} onLoginSuccess={handleLogin} />
                    {currentUser && <EditProfileModal isOpen={showProfileModal} onClose={() => setShowProfileModal(false)} currentUser={currentUser} onProfileUpdate={setCurrentUser} />}
                    {selectedRoom && <RoomDetailModal isOpen={showDetailModal} onClose={() => setSelectedRoom(null)} room={selectedRoom} />}
                </div>
            );
        };

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>